trigger:
- azure-pipelines

pool:
  vmImage: 'Ubuntu 18.04'

variables:
- group: kolga-vars

stages:
- stage: Build
  displayName: Build image
  jobs:
  - job: Build
    container: andersinnovations/devops:azure-test
    displayName: Build
    steps:
      - script: pwd && export && source ./utils/shell_utils.sh && setup_buildkit && ./devops create_images
- stage: Test
  displayName: execute tests
  jobs:
    - job: test
      container: andersinnovations/devops:azure-test
      displayName: execute tests
      steps:
        - bash: ls -la tests/registry/certs && ls /__w/1/s/tests/registry/certs
        - bash: export && pwd && ls -la && ./devops test_setup && docker-compose up -V --abort-on-container-exit --exit-code-from client
          env:
            PATH: $(PATH):$(Agent.BuildDirectory)
            BUILT_DOCKER_TEST_IMAGE: docker.anders.fi/devops/azure-kolga-demo:cbf9a0422ffb9aa2eb51c40a7c6464666bf3e6c5-development
